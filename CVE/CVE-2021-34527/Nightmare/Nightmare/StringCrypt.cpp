#include "pch.h"

#include <Windows.h>
#include <assert.h>
#include <stdlib.h>
#include "StringCrypt.h"
#include "MemOps.h"

#define INIT_XOR_KEY 0xAF

//WCHAR* XorDecryptStringW(SHORT* cp_text)
//{
//    PSHORT cursor, p_plain_text;
//    int i = 0;
//    cursor = cp_text;
//    p_plain_text = (PSHORT)malloc(sizeof(SHORT) * CRYPT_BUFF_LEN);
//    assert(p_plain_text);
//
//    while (*(cursor) && p_plain_text)
//    {
//        p_plain_text[i] = *(PBYTE)(cursor) ^ INIT_XOR_KEY;
//        p_plain_text[i] = '\0\0';
//        cursor += 2;
//        i++;
//    }
//    return (WCHAR*)p_plain_text;
//}

//Use only for string greater than CRYPT_BUFF_LEN
char* XorDecryptStringEx(BYTE* cp_text, DWORD cp_text_len, BYTE* plain_text_buf)
{
    PBYTE cursor, p_plain_text;
    int i = 0; 

    cursor = cp_text;
    p_plain_text = plain_text_buf == NULL ? (PBYTE)malloc(sizeof(BYTE) * cp_text_len) : plain_text_buf;
    assert(p_plain_text);
    mem_set(p_plain_text, cp_text_len, 0);

    while (i < cp_text_len && *(cursor) && p_plain_text)
    {
        *(p_plain_text + i) = *cursor ^ INIT_XOR_KEY;
        cursor++;
        i++;
    }

    return (char*)p_plain_text;
}

char* XorDecryptStringExWithKey(BYTE* cp_text, DWORD cp_text_len, BYTE* plain_text_buf, BYTE key)
{
    PBYTE cursor, p_plain_text;
    int i = 0;

    cursor = cp_text;
    p_plain_text = plain_text_buf == NULL ? (PBYTE)malloc(sizeof(BYTE) * cp_text_len) : plain_text_buf;
    assert(p_plain_text);
    mem_set(p_plain_text, cp_text_len, 0);

    while (i < cp_text_len && *(cursor) && p_plain_text)
    {
        *(p_plain_text + i) = *cursor ^ key;
        cursor++;
        i++;
    }

    return (char*)p_plain_text;
}

char* XorDecryptStringWithKey(BYTE* cp_text, BYTE key)
{
    PBYTE cursor, p_plain_text;
    int i = 0;
    cursor = cp_text;
    p_plain_text = (PBYTE)malloc(sizeof(BYTE) * CRYPT_BUFF_LEN);
    assert(p_plain_text);
    mem_set(p_plain_text, CRYPT_BUFF_LEN, 0);
    while (*(cursor) && p_plain_text)
    {
        p_plain_text[i] = *cursor ^ key;
        //p_plain_text[i + 1] = '\0';
        cursor++;
        i++;
    }

    return (char*)p_plain_text;
}


char* XorDecryptString(BYTE* cp_text)
{
    PBYTE cursor, p_plain_text;
    int i = 0;
    cursor = cp_text;
    p_plain_text = (PBYTE)malloc(sizeof(BYTE) * CRYPT_BUFF_LEN);
    assert(p_plain_text);
    mem_set(p_plain_text, CRYPT_BUFF_LEN, 0);
    while (*(cursor) && p_plain_text)
    {
        p_plain_text[i] = *cursor ^ INIT_XOR_KEY;
        //p_plain_text[i + 1] = '\0';
        cursor++;
        i++;
    }

    return (char*)p_plain_text;
}